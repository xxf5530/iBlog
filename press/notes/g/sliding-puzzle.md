---
date: 2023/6/27
title: 滑动拼图
category: 练习
tags:
  - 小游戏
  - 算法
---

前段时间在便利店等待结账时，看到有小孩在玩一个类似拼图的玩具，通过利用地图上的一个空位来不断挪动其它拼图的位置，最终复原出被打乱的拼图。

想起自己小时候也玩过类似的玩具，不过那时候怎么都拼不出来。于是我尝试动手做了一版，终于能够拼出来了 😎。

## 试玩

<script setup>import C from '@/demos/sliding-puzzle'</script>

<DemoWrapper><C /></DemoWrapper>

## 日志

### 实现自动求解

**BFS**

**A\***

在现有的 A\* 算法基础上，通过咨询 copilot，我得到了以下 4 个优化方向：

#### 优化数据结构

主要是对 open 列表的维护，之前的方式，在添加新的元素时，采用的排序方法是插入排序，这里改用堆排序，即用一个最小堆优先队列来表示 open 列表，这将一定程度提高运行的速度，时间复杂度从 `O(n^2)` 降低到 `O(nlogn)`。

#### 优化启发式函数

在用曼哈顿距离来估计启发函数的值，相当于我们预先假设：每一个格子处都允许堆叠多个拼图，单个拼图移动时，只需要考虑自身与目标位置的距离差即可，从而忽略了路径中其它拼图带来的影响，这也将影响估值的精确性。

以 8 puzzle 中的第一行为例，假如目标值是 `1 2 3`，对于 `0 1 2` 和 `0 2 1` 两种情况，曼哈顿距离都是 2，但是实际移动时，`0 2 1` 这种要复杂些，它后续还需要“交换” 2 和 1 的顺序，从而带来更多的操作步骤。反应在算法上，这种应该要有更大的 f 值。基于此，我们可以添加线性冲突个数来应对这类情形。

考虑引入线性冲突会带来额外的计算量，我对之前的曼哈顿距离做了预计算，提前用一个二维数组来存储任意两点间的曼哈顿距离。

#### 使用迭代深化 A 星（IDA\*）算法

#### 使用模式数据库

TODO...

### 关于开局乱序

最开始我是直接用随机的方法打乱滑块位置，但是试玩几次后，我感觉是不是有时候压根解不出来。于是我把地图规格调整成了 `2 * 2`，然后构造出了如下开局，反复移动后，我相当的确信这种就是无解的。

也就是说，要使这个游戏能正常进行下去，我们需要确保给玩家的开局一定是有解的。

一种简单的思路是考虑到每次滑动都是可逆的（滑过去后再滑回来，棋盘局面并不会变），于是可以采用从终点开始“倒着滑”的方式，每次从上下左右四个方向中随机一个方向滑动，这样重复一定次数后（次数应该与滑块总数量正相关，我这里取的是棋盘 `长 * 宽 * 10`），得到的棋盘肯定是有解的。

另一种思路就比较复杂，但更有挑战性，如果我们能找出棋盘局面与其是否有解之间的关系，是不是就可以任意构造出一种有解的棋盘呢？答案还真有，但是论证过程很复杂，需要了解线性代数中的逆序数概念，我没有整明白，这里就不再叙述 😞。

### 用图片滑块代替数字滑块

初步设想的是我只需要将一张图片均匀裁剪成 `W * H` 张小图，然后代替之前的数字即可。其中，裁剪图片可以考虑用 canvas 去实现，我参考的是这个 API [drawImage | mdn](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/drawImage)。

但是在套用到之前的模型中时，我发现有一个问题：地图上有 `W * H` 个格子，由于要留一个空格用来辅助移动，所以裁剪出来的图片其实只用到 `W * H - 1` 张，也就是说，对于一张完整的图片，我们在游戏时有一小块是"看不到的"。

一种方式是我们可以在游戏胜利时将这一小块重新填充在空格处，从而给玩家呈现一张完整的图。不过我个人并不满意，所以我又想了一个办法：将地图改成 `W * H + 1` 格，即在最后一个格子的下方再新增一个格子，这样我们就可以将所有的图片块都放进来。

经过一番折腾之后，终于是实现了这个方式。亲自试玩之后，感觉还行。

## 后记

突然知道小时候不能通关的一大原因了，因为相对于移动数字来说，移动图片要更难些（至少对我来说） 😭。
在移动数字时，我可以很轻松的获取到如下信息：

- 某个数字块最终应该移动到哪个格子
- 两个数字块最终的相对位置：谁在上，谁在下，谁在左，谁在右

而换成图片，我就不能直观的获取到这些信息（脑海中得先将图片转为数字，不过话说有对图片更敏感的人吗？），难度自然增加了不少。

## 参考链接

- [15 puzzle | wikipedia](https://en.wikipedia.org/wiki/15_Puzzle)
- [773. 滑动谜题 | 力扣](https://leetcode.cn/problems/sliding-puzzle/)
- [implementing-a-star-to-solve-n-puzzle](https://algorithmsinsight.wordpress.com/graph-theory-2/a-star-in-general/implementing-a-star-to-solve-n-puzzle/)
