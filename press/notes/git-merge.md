---
title: Git 分支合并
date: 2023/7/31
category: 笔记
tags:
  - git
---

在参与多人协作的项目开发时，解决分支合并冲突往往是一个绕不开的坎（如果用 git 作为版本管理工具的话）。

最早在自己执行 git pull 或者 git push 失败时，就已经遇到分支合并冲突了，不过我当时并不知道。后来我也一直是使用 GitHub Desktop 的图形化界面去操作分支合并，对 merge 的具体原理并未深究，也从未使用过 rebase 命令，每次遇到分支合并冲突，解决起来都是提心吊胆的。

本文尝试整理一些分支合并时的细节问题和实践应用，以便今后能更从容地应对分支合并。

## 初次使用

以一个常见的合并示例开始：假设需要将 feature 分支合并到 main 分支。

早些时候我都是这样处理：

```bash
# 先切换到目标分支
git checkout main
# 再同步远端分支内容（如果有的话）
git pull
# 最后执行合并
git merge feature
```

> 另外，从 git 2.33 版本（2021 年 8 月发布） 开始，切换分支也可使用 git switch 命令

如果一切顺利的话（指不需要我们手动解决冲突），我们大概率能在控制台看到 `Fast-forward` 或者 `Merge made by the 'ort' strategy` 字样。

这里先简单理解下这两者背后的含义。

### 快进合并

我们可以借助分支上的 HEAD 指针说明为什么执行了快进合并（fast-forward merge）。

假如沿着 feature 分支上的 HEAD 指针指向，逐步向后回退，如果某次回退后恰好与 main 分支上的 HEAD 指针重合，那么这次合并就会执行快进合并，也就是说此时只需要将 main 分支上 HEAD 指针向前移动若干步就可以指向 feature 分支上 HEAD 指针处，由于整个过程它不用再创建新的提交点，所以我们在提交记录中不会看到分叉点产生。

快进合并不会产生新的提交点，相当于执行了一次隐式合并（从提交历史上看不出这些提交是从其它分支合并过来的，还是在该分支上直接提交的）。如果我们需要保留分支的信息，可以通过在合并时添加 `--no-ff` 选项来禁用快进合并，这样就会强制 git 生成一个新的合并提交，从而保留了分支的信息。

### 三路合并

在快进合并中，git 只需要两个提交节点就可以确定合并后的结果。但在不满足快进合并的时候，git 往往需要以下三个提交节点来确定合并后的结果：

1. main 分支的上的最新提交点
2. feature 分支的最新提交点
3. main 分支和 feature 分支的最近公共祖先节点（假设称呼为 Base 节点）

我们可以这样去理解为什么需要“三路节点” 🤔。

首先，我们知道在将 feature 分支合并到 main 分支时，如果出现了冲突，就意味着同一个文件下，某块内容在 feature 分支和 main 分支中不同，但 git 能否自行解决呢？

在仅有两个节点做参考的情况下，这应该是做不到的。要么用你的，要么用我的，我开始还想着按最后提交时间来定，但转念一想，这样不就变成了在线文档了吗？

如果引入第三个节点 —— Base 节点（最近公共祖先节点），git 是不是可以自行解决一些冲突？例如，在冲突处，如果 feature 分支的内容和最近公共祖先节点的内容是一致的，那么可以理解这里变动是 main 分支单独引入的，也是“最新的”，合并时直接采用 main 分支上的内容即可，反之亦然。

不过由于一个提交节点可以有多个父提交节点，导致这个最近公共祖先节点可能不止一个。这个时候，git 会递归地将这些共同祖先合并成一个虚拟的基准（一个不存在的提交，它的内容是将所有共同祖先的内容按照三路合并的规则合并后的结果），然后以这个虚拟的基准为 Base 节点，再进行三路合并。这个算法就是递归三路合并（recursive three-way merge）。

> 这个算法也在“进化”，在 v2.33 版本中重构成新的 `ort` 策略亮相，详情查看 [merge-ort-a-new-merge-strategy](https://github.blog/2021-08-16-highlights-from-git-2-33/#merge-ort-a-new-merge-strategy)

### 策略选项

在执行 git merge 时可以附加 `-s` 选项手动指定策略，以下是一些常见策略的介绍：

`ort`：

- 合并单个分支时默认策略

`octopus`：

- 同时合并一个以上分支时的默认策略（章鱼有八只脚，那一次是不是最多只能合并 8 个分支 😄）
- 执行 `git merge b1 b2 b3` 表示将 `b1`、`b2`、`b3` 分支合并到当前分支
- 如果遇到需要手动解决的复杂冲突，它会自动中止本次合并（相当于什么也没有发生）

`ours`、`theirs`：

- 对待冲突采用“一刀切”的处理策略
- 对于 `our` 选项，例如使用 `git merge -s ours b1`，意味着冲突部分以（我们）当前分支为准，完全覆盖了（他们） `b1` 分支中冲突的内容， 而 `theirs` 选项与之相反，冲突部分完全以（他们） `b1` 分支内容为准，覆盖（我们）当前分支部分

::: info TL;DR 👀

更详细的介绍：[git merge 合并策略](https://git-scm.com/docs/git-merge/zh_HANS-CN#_%E5%90%88%E5%B9%B6%E6%88%98%E7%95%A5)

:::

## 关于冲突

### 冲突的表示

对于需要手动解决的冲突， git 默认会在冲突处添加三行额外的标记：

> 如果我们使用 vscode 打开任意一个 git 工作目录，然后找个文件手动添加这三个标记，会发现也能“激活”编辑器自带的合并插件

- `<<<<<<<`：表示当前分支冲突部分的开始
- `=======`：表示当前分支冲突部分的结束 和 待合并分支冲突的开始
- `<<<<<<<`：表示待合并分支冲突部分的结束

举个简单例子：下面表示一个需要手动解决的冲突，易知当前分支内容是 Hello world，而待合并的目标分支，内容是 Goodbye。 我们需要自行决定保留哪一个或者重新写，最后再删除这些标记，表示我们已经手动解决了这个冲突。等到所有冲突解决完毕，就可以执行 git commit 了。

```bash
<<<<<<< HEAD
Hello world
=======
Goodbye
>>>>>>> feature
```

不过实际操作起来，有时会因这里给出的信息可能过于“简陋”而难以抉择，比如：

- 没有上下文显示
- 没有显示最近公共祖先节点处的内容（三路合并算法中的一路）

git 其实有提供额外的展示冲突风格的选项：`diff3` 和 `zdiff3`，不过需要用户手动配置（默认值是 `merge`）

> `zdiff3` 在 v2.35 版本（2022 年 1 月发布）中首次引入

```bash
# 单个文件配置
git checkout --conflict=diff3 < 文件路径 >
# 当前仓库配置
git config merge.conflictstyle diff3
# 全局配置
git config --global merge.conflictstyle diff3
```

开启后会使用一个新的标记 `|||||||`，表示最近公共祖先节点出在该冲突部分的开始

还是我们上面的例子，新出现的 `|||||||` 和 `=======` 中间部分就是当前分支和待合并分支的最近公共祖先节点的内容（ `|||||||` 行后面是最近公共祖先节点的 commit-id）

```bash
<<<<<<< HEAD
Hello world
||||||| 50bb135
See you again
=======
Goodbye
>>>>>>> feature
```

### 冲突的产生

TODO...

### 冲突的解决

TODO...

## 一些补充

TODO...

### 列举合并失败的场景

### cheery-pick

<details class="note" open>
  <summary>🍒 背景</summary>
  <p>有个“好听”的中文译名: “摘樱桃”，背景源自于樱桃的采摘过程。这里用于允许开发人员选择合并特定的提交，就像人们在摘取樱桃时，通常会优先挑选其中品质更好的。</p>
</details>

顾名思义，使用 cherry-pick 可以挑选不同分支上的提交的变更，然后在当前分支上创建一个新的提交，这个提交包含了从其他分支中选择的提交的更改。这个新的提交的父提交是当前分支的最新提交，不会跟挑选的提交所在分支产生关联。这样就可以将其他分支的某个提交的变更添加到当前分支上，而不影响其他分支的历史。

以下是一些使用命令参考：

```bash
# 挑选多个不连续的提交
git cherry-pick <commit-id> <commit-id> <commit-id>

# 将从 A 到 B 的所有提交应用到当前分支，但是不包括 A 提交本身
git cherry-pick A..B

# 将从 A 到 B 的所有提交应用到当前分支，并且包括 A 提交本身
git cherry-pick A^..B
```

## 参考链接

- [Git 官方文档 - git-merge](https://git-scm.com/docs/git-merge/zh_HANS-CN)
- [Atlassian Git 教程 - Git 合并](https://www.atlassian.com/zh/git/tutorials/using-branches/git-merge)
- [《Pro Git》- 高级合并](https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E9%AB%98%E7%BA%A7%E5%90%88%E5%B9%B6)
